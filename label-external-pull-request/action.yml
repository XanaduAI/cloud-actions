name: Label External Pull Requests
description: Checks if a PR is a fork and applies an external label accordingly

inputs:
  github_token:
    description: The GitHub token to use read member status
    required: true
  team:
    description: The team slug for external collaborators
    required: true
  org:
    description: The organization to check membership in
    required: true
  username:
    description: The username to check membership for
    required: true

runs:
  using: composite
  steps:
    - uses: actions/github-script@v7
      id: set-result
      env:
         GITHUB_ORG: ${{ inputs.org }}
         GITHUB_TEAM_SLUG: ${{ inputs.team }}
         GITHUB_USERNAME: ${{ inputs.username }}
      with: 
        github-token: ${{ inputs.github_token }}
        result-encoding: string
        script: |
          const response = await github.rest.teams.getMembershipForUserInOrg({
            org: process.env.GITHUB_ORG,
            team_slug: process.env.GITHUB_TEAM_SLUG,
            username: process.env.GITHUB_USERNAME,
          });
          return response.data.state === 'active';
    - name: Add label
      shell: bash
      env:
        PR_HTML_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ github.token }}
      if: github.event.pull_request.head.repo.fork == true || steps.set-result.outputs.result == 'true'
      run: gh pr edit "$PR_HTML_URL" --add-label "external"
            
